#### 问题
    在一些同学做年度okr总结的时候，常常需要回看过去一年的数据，在时间跨度较大的场景下，G2（折线图、柱状图等）会出现明显的性能瓶颈，在一个看板存在多个G2图表并且时间跨度大的场景下，会出现严重的不跟手现象。为此，我们查阅G2源码，最终定位到为G2label显示位置计算导致的抢占UI渲染主线程问题，于是修改源码之路开启


# G2 大跨度标签性能问题定位与优化

## 背景
- 看板场景中常同时渲染多个 G2 图表（折线、柱状等），且时间跨度很大（数百到上千点）。
- 用户在年度回溯时打开这些看板，出现明显卡顿、不跟手，滚动与交互响应延迟上升。

## 现象
- 页面主线程占用飙升，FPS 明显下降，输入事件响应变慢。
- DevTools Performance 录制显示长时间的 Layout/Style 计算和 DOM 测量。
- 关闭标签或减少标签后，卡顿明显缓解，指向“标签渲染/布局”链路为高占用环节。

## 复现
- 提高图表数量与数据跨度：
  - 图表数量：`apps/admin/src/views/G2Perf.vue:93` 设置较大的 `chartCountLarge`
  - 数据点数：`apps/admin/src/views/G2Perf.vue:106` 使用大跨度数据生成（如 `gen(1000)`）
- 开启标签，切换到“大跨度”页签观察卡顿。

## 技术定位路径
1. 确认使用本地 G2 源码
   - Vite alias 指向本地：`apps/admin/vite.config.ts:10-15`
   - 启动日志：`apps/G2/src/index.ts:8` 打印 “>>> 这是本地 G2”

2. 锁定标签渲染管线
   - 视图级标签渲染入口：`apps/G2/src/runtime/plot.ts:1103-1192`
     - 收集每个 mark 的标签，按 `labelOption.transform` 组装标签变换并执行
   - 本地注册的标签变换：
     - `labelTransform.overflowHide` → `apps/G2/src/label-transform/overflowHide.ts`
     - 注册表：`apps/G2/src/lib/core.ts:308-312`

3. 验证变换生效路径
   - 正确用法：在 `geom.label({ ..., transform: [...] })` 中配置变换（组件端）
   - 修正后会触发本地 `OverflowHide` 构造日志：`apps/G2/src/label-transform/overflowHide.ts:12-21`

## 根因分析
- `OverflowHide` 实现核心：对每个标签执行
  - `show(l)`/`hide(l)` 切换样式
  - `l.getLocalBounds()` 测量标签包围盒
  - 与 `bounds` 比较越界，越界则隐藏
- 性能瓶颈来源：
  - 大量标签时，对每个标签的测量和样式切换会触发频繁的布局/样式计算（Layout/Style thrashing）
  - “复杂标签”体积更大（多行文本、背景、阴影），测量与绘制成本更高
  - 多图叠加、时间跨度大导致标签数线性增长，从而主线程被大量测量与重排占据

## 证据链
- 标签流水线执行变换：`apps/G2/src/runtime/plot.ts:1168-1183`
- 变换实现使用 `getLocalBounds()` 和样式切换：`apps/G2/src/label-transform/overflowHide.ts:12-21`
- 组件端“复杂标签”生成路径（富文本标签）：`apps/admin/src/components/g2/G2LineChart.vue:53-76`
- 简单标签默认步长为 1 时，几乎每个数据点都生成标签：`apps/admin/src/components/g2/G2LineChart.vue:79-81`

## 影响范围
- 大跨度数据集（> 500 点）
- 多图表同时渲染（> 6 个）
- 标签为复杂样式或显示频率高（步长过小）

## 优化方案与实现
- 限制标签数量（核心）
  - 动态步长，保证最多显示 30 个标签：
    - `apps/admin/src/views/G2Perf.vue:170-174` 定义 `labelStepFor(ds)`
    - 使用：`apps/admin/src/views/G2Perf.vue:39` 应用于大跨度图表
- 渐进渲染，避免一次性绘制所有图表
  - Loading + 分批渲染（每批 3 个，约 120ms 间隔）：
    - 容器 Loading：`apps/admin/src/views/G2Perf.vue:34-44`
    - 状态与逻辑：`apps/admin/src/views/G2Perf.vue:93-96, 108-131, 194`
- 组件端正确接入标签变换
  - 使用 `label.transform`，确保走本地 `overflowHide`：
    - 简单标签：`apps/admin/src/components/g2/G2LineChart.vue:79-81, 114-119`
    - 复杂标签：`apps/admin/src/components/g2/G2LineChart.vue:75-77, 110-112`
- 布局优化
  - 大跨度页签使用 `flex + wrap` 布局，提升首屏可视与渲染节奏：
    - 模板与样式：`apps/admin/src/views/G2Perf.vue:34-44, 205`

## 验证结果
- 性能录制显示主线程占用下降，交互更跟手
- 标签数量显著减少（最多 30），`OverflowHide` 仍能在越界场景有效生效
- 渐进渲染避免了突发的长任务，切页体验明显改善

## 建议与后续
- 业务侧尽量控制标签显示频率，优先展示关键点
- 大跨度图表建议默认开启渐进渲染与 Loading
- 若继续深挖，可在 `OverflowHide` 中对测量与样式切换做批处理，避免 Layout thrashing
- 对“复杂标签”样式进行简化（去掉阴影、背景），进一步降低测量与绘制成本

```mermaid
flowchart TD
  A[Chart.render] --> B[render]
  B --> B1[inferKeys]
  B --> B2[Canvas init]
  B --> B3[emit BEFORE_RENDER]
  B --> C[plot]
  C --> C1[类型标准化 transform]
  C1 --> C1a[standardView]
  C --> D[initializeView]
  D --> D1[transformMarks]
  D1 --> D1a[applyMarkTransform<br/>(transform 管线)]
  D1a --> T1[applyDefaults / applyDataTransform / flatEncode]
  D1a --> T2[inferChannelsType / maybeVisualChannel / extractColumns / maybeArrayField / maybeNonAnimate]
  D1a --> T3[addGuideToScale / normalizeTooltip]
  D1a --> T4[preInference[] / transform[] / postInference[]]
  D1a --> T5[extractTooltip]
  D --> D2[bubbleOptions / coordinate2Transform]
  D --> E[initializeMarks]
  E --> E1[按通道分组推断 Scale]
  D --> F[initializeState]
  F --> F1[collectScales / inferComponent / normalizeComponents]
  F --> F2[computeLayout / createCoordinate / placeComponents / processAxisZ]
  F --> F3[实例化 Scale / assignScale / applyScale]
  F --> F4[SingleMark 计算点集 / filterValid / 视觉数据]
  C --> G[emit BEFORE_PAINT]
  C --> H[plotView]
  H --> H1[渲染背景区域]
  H --> H2[渲染组件 renderComponent]
  H --> H3[渲染主图层 / marks join]
  H --> H4[plotLabel 渲染标签]
  H4 --> H4a[按 label 配置分组]
  H4 --> H4b[useLabelTransform 组合执行]
  H4b --> L1[overflowHide / overlapHide / ...]
  C --> I[emit AFTER_PAINT]
  B --> B4[emit AFTER_RENDER]
  ```